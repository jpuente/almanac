% -*- coding: utf-8 -*-

\chapter{Integración}
El funcionamiento del sistema requiere la integración de sus distintos componentes. El robot debe combinar su capacidad para localizarse correctamente en el entorno con el seguimiento de una trayectoria adecuada, resultante de la planificación y el control reactivo. La localización resulta imprescindible para el buen funcionamiento del control y, particularmente, para situaciones en que el robot quede alejado de la trayectoria definida (como en la figura \ref{fg:reg}).

La interacción entre el módulo de localización y el de control de movimiento se lleva a cabo mediante la clase \prog{CRobot}, como puede apreciarse en el diagrama \ref{fg:uml}. Desde las clases \prog{CRobotGLWnd} y \prog{CControl3GUIDlg} se realiza la transferencia de información desde la interfaz gráfica al resto del programa. En esta última se tiene el objeto \prog{gl_wnd}, de la clase \prog{CRobotGLWnd}, el objeto \prog{robot}, de la clase \prog{CRobot} y el objeto \prog{control}, de la clase \prog{CMoveControl}. Desde \prog{robot} se tiene un puntero al objeto \prog{control}. Desde \prog{gl_wnd} se tienen punteros a  \prog{robot} y a \prog{control} (para simplificar las llamadas a sus métodos y no tener que utilizarlos a través del puntero al objeto \prog{robot}).

\section{La clase CRobot}
El papel de esta clase consiste en integrar:
\begin{itemize}
  \item la obtención de los datos de odometría y del láser
  \item la estimación o/y corrección de la posición mediante el filtro de Kalman y la actualización del mapa
  \item el paso de la posición corregida y del mapa de obstáculos al módulo de control de movimiento
\end{itemize}

Para ello se dispone de algunas variables miembro importantes:
\begin{itemize}
  \item \prog{robotdata}, de la clase \prog{CRobotDataReal}
  \item \prog {proc_laser_data}, de la clase \prog{CProc_Laser_Data}
  \item \prog{loc}, de la clase \prog{CKalman_Loc}
  \item \prog{control}, puntero a un objeto de la clase \prog{CMoveControl} (que habrá de apuntar al objeto \prog{control} miembro del diálogo \prog{CControl3GUIDlg})
\end{itemize}

\noindent
También posee una variable puntero a un objeto de tipo \prog{CPioneer}, para las pruebas de control que se han hecho con el robot P3AT.

%Las funciones que forman parte de la clase son las siguientes:

%\subsection{SetPioneer}
%
%\noindent
%\prog{void SetPioneer(CPioneer* pioner)}
%
%\noindent
%Esta función se emplea para hacer que el puntero miembro de \prog{CRobot} apunte a un objeto \prog{CPioneer} determinado que se le pasa como parámetro.
%
%\begin{itemize}
%  \item \prog{pioner}: puntero al objeto de la clase \prog{CPioneer} al que se quiere apuntar desde un objeto \prog{CRobot}.
%\end{itemize}
%
%\subsection{SetControl}
%
%\noindent
%\prog{void SetControl(CMoveControl* cont)}
%
%\noindent
%Esta función se utiliza para hacer que el puntero miembro de \prog{CRobot} apunte a un objeto \prog{CMoveControl} determinado que se le pasa como parámetro.
%
%\begin{itemize}
%  \item \prog{cont}: puntero al objeto de la clase \prog{CMoveControl} al que se quiere apuntar desde un objeto \prog{CRobot}.
%\end{itemize}
%
%\subsection{shutdown}
%
%\noindent
%\prog{void shutdown()}
%
%\noindent
%Esta función sirve para desconectar el robot Pioneer en caso de que se esté utilizando.

\subsection{ProcessData}

\noindent
\prog{int ProcessData()}

\noindent
Es la función principal de la clase. Sirve para integrar los componentes que se han indicado anteriormente.

\noindent
En primer lugar se actualizan los datos odométricos y del láser mediante \prog{robotdata.UpdateData()}.

Si se han obtenido datos de la odometría (valor de retorno \prog{ODOM_DATA} o \prog{DATA_ODOM_LASER}) se calcula el incremento que ha de utilizarse para la etapa de predicción del algoritmo de localización a partir de la transformación inversa de la posición odométrica previa y su composición con la posición odométrica recién obtenida. La nueva posición se guarda como posición antigua para la siguiente llamada a la función. En caso de que se haya añadido un ruido adicional (a través del cuadro de diálogo), se inyecta éste en el incremento de odometría mediante composición con aquél. La posición odométrica con el ruido extra se guarda en un vector de la STL para su representación gráfica. Por último se calcula la predicción de la posición odométrica mediante \prog{loc.KalmanPos} con los argumentos correspondientes al incremento de odometría calculado.

Si se han obtenido datos del láser (\prog{robotdata.UpdateData()} ha devuelto \prog{LASER_DATA} o \prog{DATA_ODOM_LASER}) lo primero que se hace es procesar la información del mismo que estará disponible en la variable de la clase \prog{CRawLaserData} perteneciente a \prog{robotdata} para que en \prog{proc_laser_data} se tenga el vector \prog{v} con los puntos correspondientes a las medidas del láser (llamada a \prog{proc_laser_data}.\prog{DefineData}(\prog{robotdata.laser_data}).
Seguidamente se realizan las operaciones necesarias para calcular los puntos del polígono correspondiente a esa serie de medidas del láser mediante el objeto \prog{proc_laser_data}. Se obtienen también los ángulos $\alpha$ de la figura \ref{fg:poligono} y se pasan éstos y la información del polígono a variables miembro del objeto \prog{loc}. Se calcula la corrección de la posición estimada por medio de \prog{loc.KalmanUpdate}, pasándole como argumento el vector \prog{v} de la variable \prog{proc_laser_data}.

La posición resultante de esta actualización se guarda en un vector de la STL para representar en la interfaz gráfica la trayectoria corregida mediante el algoritmo de localización y poder compararla con la trayectoria basada únicamente en los datos de la odometría.

Esta nueva posición es la que ha de utilizar el control de movimiento. Como las variables \prog{x} y \prog{y} de la clase \prog{CMoveControl} son públicas, basta con asignarles el valor correspondiente a la posición corregida con el filtro de Kalman.

Lo último que se hace es pasarle a la variable \prog{control} el vector de puntos del mapa (actualizado en la llamada a \prog{ KalmanUpdate}) como vector que contiene los obstáculos a evitar por el control reactivo y efectuar la deformación de la trayectoria mediante \prog{control.ComputeElasticTray()}.

El valor de retorno es 1 si se han actualizado datos de odometría o del láser y 0 en caso contrario.

Esta función va a ejecutarse a modo de bucle, dentro de un \emph{timer} que se define en la clase \prog{CControl3GUIDlg}.

\section{La clase CControl3GUIDlg}
Esta clase hereda de la clase pública \prog{CDialog}, perteneciente a las MFC. En ella comienza el hilo principal de ejecución del programa. Desde esta clase se crea el cuadro de diálogo, al que han de añadirse los diferentes botones para realizar el paso de información del usuario a los distintos componentes del sistema. En ella se tiene la variable \prog{gl_wnd} para crear la ventana gráfica y asociarla a él. Como se ha mencionado, proporciona el modo de controlar el ciclo de tareas que ha de realizar el robot mediante un temporizador o \emph{timer} que permite la repetición de una serie de acciones periódicamente. La variable \prog{robot}, de acuerdo con lo visto, es necesaria para obtener la posición corregida y el mapa y hacer posible su utilización desde el control de movimiento en cada momento. La variable \prog{control} se emplea para facilitar el acceso a aquél. %Las principales funciones editadas en esta clase son:

\section{Interfaz de usuario}
Aunque ya se ha mostrado en otras figuras, a continuación se presenta el aspecto de la interfaz de usuario desarrollada. En esta imagen se ve tal y como aparece al iniciarse la ejecución del programa (salvo los colores de fondo y cuadrícula, que por defecto son negro y magenta pero pueden cambiarse pulsando en el teclado la letra 'F'). Seguidamente se describirán sus propiedades y la utilidad de sus botones.

\begin{figure}[h]
  % Requires \usepackage{graphicx}
  \centering\includegraphics[scale=0.4]{interfaz}\\
  \caption{Interfaz de usuario}\label{fg:interfaz}
\end{figure}


\subsection{Funcionalidad de los botones del diálogo}

\subsubsection{OK y Cancelar}

\noindent
Siempre que se pulse alguno de estos botones se cierra la interfaz de usuario y finaliza la ejecución del programa.

\subsubsection{Reset}
\noindent
Se emplea para anular la definición de una trayectoria y de una serie de obstáculos realizada mediante el ratón.

\subsubsection{Guardar Mapa}

\noindent
Se utiliza para guardar los puntos de un mapa en un fichero. Al ser pulsado se abre el típico cuadro de Windows \emph{Guardar Como} para seleccionar el directorio y el nombre. De esta forma que no tienen que realizarse nuevos mapas cada vez sino que pueden ser leídos mediante \emph{Leer mapa}:

\subsubsection{LeerMapa}

\noindent
Muestra un cuadro de Windows tipo \emph{Abrir} para establecer como mapa los puntos leídos de un fichero creado mediante \emph{Guardar Mapa}.

\subsubsection{Ir a punto}

\noindent
Se emplea para que el robot siga una trayectoria definida sobre la interfaz gráfica mediante el ratón.

\subsubsection{Guardar Tray}

\noindent
Permite guardar la trayectoria que sigue el robot, para que luego pueda regresar al punto de partida. Ha de pulsarse en el momento en que se desee que empiece a guardarse el camino, normalmente antes de que comience el movimiento del robot.

\subsubsection{Volver}

\noindent
Cuando se pulsa este botón el robot emprende el camino de regreso por la misma trayectoria seguida hasta el momento.

\subsubsection{Opciones}
Dentro de este grupo de botones de tipo \emph{check-box} se ofrecen algunas alternativas de funcionamiento del sistema:
\begin{itemize}
  \item Actualiza: permite añadir o no puntos al mapa en función de las medidas del láser. Si no se ha leído ningún mapa mediante \emph{Leer Mapa} y no se marca esta opción, el mapa permanecerá vacío y no podrá efectuarse la localización. Puede variarse la condición elegida a lo largo del funcionamiento del sistema.
  \item Borrar: sirve para establecer si se han de borrar los puntos dinámicos mediante el algoritmo del polígono envolvente o no. En caso afirmativo se dibuja sobre la pantalla el polígono correspondiente en cada momento y los puntos que han sido borrados aparecen en color cyan.
\end{itemize}

\subsubsection{Modo}
Este grupo de botones \emph{radio-box} se emplea para seleccionar el tipo de conexión que se desea.
\begin{itemize}
  \item Simulacion: establece el funcionamiento del sistema en modo simulación
  \item Fichero: establece el funcionamiento del sistema en modo fichero
  \item Real: establece el funcionamiento del sistema en modo real
\end{itemize}

\subsubsection{LogData}
Permite guardar en un fichero los datos de odometría y del láser mediante la llamada al método \prog{StartLogData} de la clase \prog{CRobotData}.

\subsubsection{StopLogData}
Se utiliza para cerrar el fichero anterior y de este modo dejar de registrar los datos. Básicamente realiza una llamada a \prog{StopLogData} de la clase \prog{CRobotData}.

\vspace{0.2cm}
\noindent
Lógicamente, los dos botones anteriores no se encuentran activados si el modo de funcionamiento es tipo fichero.

\subsubsection{Desviación típica de odometría}
En esta \emph{edit box} puede introducirse el valor de la desviación típica en los datos de la odometría que se ha de utilizar en el filtro de Kalman. Si en ella no se escribe ningún valor, se emplea una desviación típica de 0.1.

\subsubsection{Ruido adicional}
El valor que se introduzca en esta \emph{edit box} será inyectado como ruido adicional a la odometría. Permite evaluar el funcionamiento del algoritmo de localización con distintas calidades de los datos odométricos. Si no se escribe nada en el cuadro, el valor por defecto es 0.

\subsubsection{Mensaje}
En esta \emph{edit box} se muestra información sobre la última acción que se le ha pedido que realice al robot (\emph{Guardando trayectoria}, \emph{Siguiendo trayectoria})...

\subsubsection{Start}
Con este botón se inicia un temporizador para que se ejecute el ciclo de tareas del robot cada cierto tiempo (periodo de 10ms en los modos simulación y fichero y de 150ms en modo real). Conviene utilizarlo una vez se han seleccionado los parámetros de funcionamiento.

\subsubsection{Pause}
Este botón mata el temporizador y con ello dejan de realizarse las actualizaciones del ciclo, por lo que el sistema se mantiene estático hasta que vuelva a lanzarse el ciclo de tareas pulsando de nuevo el botón \emph{Start}.

\subsection{Selección de opciones mediante ratón o teclado}
Por medio del ratón pueden realizarse los siguientes cambios relativos a la visualización:
\begin{itemize}
  \item Acercamiento y alejamiento del punto de vista mediante giro de la rueda del ratón en uno u otro sentido. El mismo resultado se obtiene moviendo el ratón con el botón derecho pulsado.
  \item Variación del punto de vista manteniendo apretado el botón izquierdo del ratón mientras se mueve.
  \item Desplazamiento del origen de coordenadas del sistema de referencia global sobre el plano representado en la interfaz gráfica pulsando simultáneamente el botón izquierdo del ratón y el botón \emph{Ctrl} del teclado y arrastrando el cursor.
  \item Desplazamiento del origen de coordenadas de sistema global sobre el eje z del mismo al mover el ratón y mantener pulsados el botón derecho y la tecla \emph{Ctrl}.
  \item Creación y representación de obstáculos mediante doble click con el botón izquierdo del teclado. Si existe una trayectoria definida esta acción provoca la deformación de la misma.
  \item Definición de puntos de una trayectoria. Si no se trata del primer punto de la misma, se obtiene la trayectoria redondeada inmediatamente después de haberse añadido el nuevo punto.
\end{itemize}

A través del uso único del teclado pueden hacerse más modificaciones:
\begin{itemize}
  \item Cambio del tipo de representación de 2D a 3D y viceversa con la tecla correspondiente a la letra 'P'
  \item Cambio del color del fondo y algunos otros colores con la tecla correspondiente a la letra 'F'
  \item Ocultar o mostrar la cuadrícula que muestra el plano del movimiento con la tecla correspondiente a la letra 'G'
  \item Mostrar o no mostrar la trayectoria definida, la trayectoria modificada y los obstáculos mediante las teclas correspondientes a las letras 'T', 'E' y 'O' respectivamente
  \item Aumentar y disminuir el tamaño de las celdas de la cuadrícula por medio de las teclas correspondientes a las letras 'M' y 'L'
  \item Movimiento del robot en modo teleoperado. La letra 'W' se utiliza para aumentar la velocidad de avance; la 'S', para disminuir la velocidad de avance; la 'D', para incrementar la velocidad de giro (sentido de las agujas del reloj, figura \ref{fg:velocidades}); la 'A' para disminuir la velocidad de giro (o incrementarla en sentido antihorario) y la barra de espaciado se emplea para hacer nulas las velocidades del robot y que éste se detenga.
\end{itemize} 